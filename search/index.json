[{"content":"Web - Armaxis In the depths of the Frontier, Armaxis powers the enemyâ€™s dominance, dispatching weapons to crush rebellion. Fortified and hidden, it controls vital supply chains. Yet, a flaw whispers of opportunity, a crack to expose its secrets and disrupt their plans. Can you breach Armaxis and turn its power against tyranny?\nAnalysis We are given nodejs application and email service with address of test@wmail.htb.\nBased on the flag location in the source code, we need to at least obtain File Read or Code Execution within the application.\n1 COPY flag.txt /flag.txt After reading the source code, i found that parseMarkdown are using execSync with unsafe usage. This will allow us to obtain code execution if we manage to control the url value.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 function parseMarkdown(content) { if (!content) return \u0026#39;\u0026#39;; return md.render( content.replace(/\\!\\[.*?\\]\\((.*?)\\)/g, (match, url) =\u0026gt; { try { const fileContent = execSync(`curl -s ${url}`); const base64Content = Buffer.from(fileContent).toString(\u0026#39;base64\u0026#39;); return `\u0026lt;img src=\u0026#34;data:image/*;base64,${base64Content}\u0026#34; alt=\u0026#34;Embedded Image\u0026#34;\u0026gt;`; } catch (err) { console.error(`Error fetching image from URL ${url}:`, err.message); return `\u0026lt;p\u0026gt;Error loading image: ${url}\u0026lt;/p\u0026gt;`; } }) ); } url value are obtain using regex, which will search for markdown image format such as:\n1 ![test](http://yooursite.com) this way, we can inject payload below to obtain code execution\n1 ![test](http://yooursite.com;id) parseMarkdown function was called within /weapons/dispath routes and only accessible for user with admin privileges.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 router.post(\u0026#34;/weapons/dispatch\u0026#34;, authenticate, async (req, res) =\u0026gt; { const { role } = req.user; if (role !== \u0026#34;admin\u0026#34;) return res.status(403).send(\u0026#34;Access denied.\u0026#34;); const { name, price, note, dispatched_to } = req.body; if (!name || !price || !note || !dispatched_to) { return res.status(400).send(\u0026#34;All fields are required.\u0026#34;); } try { const parsedNote = parseMarkdown(note); await dispatchWeapon(name, price, parsedNote, dispatched_to); res.send(\u0026#34;Weapon dispatched successfully.\u0026#34;); } catch (err) { console.error(\u0026#34;Error dispatching weapon:\u0026#34;, err); res.status(500).send(\u0026#34;Error dispatching weapon.\u0026#34;); } }); admin users were defined within database initialization below\n1 2 3 4 5 await runInsertUser( \u0026#34;admin@armaxis.htb\u0026#34;, `${crypto.randomBytes(69).toString(\u0026#34;hex\u0026#34;)}`, \u0026#34;admin\u0026#34;, ); To obtain admin credentials, we can perform an account takeover through the reset password feature. This feature allows users to reset their password using a token sent to their email. However, there is no validation to ensure that the token is assigned to the correct user. Additionally, we can supply any email address during the password reset process.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 router.post(\u0026#34;/reset-password/request\u0026#34;, async (req, res) =\u0026gt; { const { email } = req.body; if (!email) return res.status(400).send(\u0026#34;Email is required.\u0026#34;); try { const user = await getUserByEmail(email); if (!user) return res.status(404).send(\u0026#34;User not found.\u0026#34;); const resetToken = crypto.randomBytes(16).toString(\u0026#34;hex\u0026#34;); const expiresAt = Date.now() + 3600000; await createPasswordReset(user.id, resetToken, expiresAt); await transporter.sendMail({ from: \u0026#34;noreply@frontier.com\u0026#34;, to: email, subject: \u0026#34;Password Reset\u0026#34;, text: `Use this token to reset your password: ${resetToken}`, }); res.send(\u0026#34;Password reset token sent to your email.\u0026#34;); } catch (err) { console.error(\u0026#34;Error processing reset request:\u0026#34;, err); res.status(500).send(\u0026#34;Error processing reset request.\u0026#34;); } }); router.post(\u0026#34;/reset-password\u0026#34;, async (req, res) =\u0026gt; { const { token, newPassword, email } = req.body; // Added \u0026#39;email\u0026#39; parameter if (!token || !newPassword || !email) return res.status(400).send(\u0026#34;Token, email, and new password are required.\u0026#34;); try { const reset = await getPasswordReset(token); if (!reset) return res.status(400).send(\u0026#34;Invalid or expired token.\u0026#34;); const user = await getUserByEmail(email); if (!user) return res.status(404).send(\u0026#34;User not found.\u0026#34;); await updateUserPassword(user.id, newPassword); await deletePasswordReset(token); res.send(\u0026#34;Password reset successful.\u0026#34;); } catch (err) { console.error(\u0026#34;Error resetting password:\u0026#34;, err); res.status(500).send(\u0026#34;Error resetting password.\u0026#34;); } }); 1 2 3 4 5 6 7 8 9 async function getPasswordReset(token) { const query = `SELECT * FROM password_resets WHERE token = ? AND expires_at \u0026gt; ?`; try { const reset = await get(query, [token, Date.now()]); return reset; } catch (error) { throw error; } } Exploitation In order to takeover admin account, we need to:\nregister using test@email.htb perform reset password action obtain reset password token change email address upon form submission from test@email.htb into admin account admin@armaxis.htb now we can logged in into admin account the next step is to exploit code injection within dispatch weapon feature which will reflect in home page base64-decode the value will show the command output the last step is to read the flag in /flag.txt Flag : HTB{l00k0ut_f0r_m4rkd0wn_LF1_1n_w1ld!_ed3f0dc157df0cc33fc59f2854b4d9ee}\n","date":"2024-12-18T08:04:09.436Z","image":"https://blog.lordrukie.com/p/htb-ctf-university-2024-armaxis/banner_hu14446989486656516761.png","permalink":"https://blog.lordrukie.com/p/htb-ctf-university-2024-armaxis/","title":"[HTB CTF University 2024] - Armaxis"}]